<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.21.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Nextcloud Sync Client for Docker | stouty.xyz</title>
<meta name="description" content="Syncing to Nextcloud from a Docker container, and how to build that container.">


  <meta name="author" content="James Stout">
  
  <meta property="article:author" content="James Stout">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="stouty.xyz">
<meta property="og:title" content="Nextcloud Sync Client for Docker">
<meta property="og:url" content="https://stouty.xyz/nextcloud/2020/05/08/nextcloud-sync/">


  <meta property="og:description" content="Syncing to Nextcloud from a Docker container, and how to build that container.">





  <meta name="twitter:site" content="@stoutyhk">
  <meta name="twitter:title" content="Nextcloud Sync Client for Docker">
  <meta name="twitter:description" content="Syncing to Nextcloud from a Docker container, and how to build that container.">
  <meta name="twitter:url" content="https://stouty.xyz/nextcloud/2020/05/08/nextcloud-sync/">

  
    <meta name="twitter:card" content="summary">
    
  

  
    <meta name="twitter:creator" content="@stoutyhk">
  



  <meta property="article:published_time" content="2020-05-08T22:27:27+08:00">






<link rel="canonical" href="https://stouty.xyz/nextcloud/2020/05/08/nextcloud-sync/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "stouty.xyz",
      "url": "https://stouty.xyz/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="stouty.xyz Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<script src="/assets/files/head.load.min.js"></script>

<!-- <script defer src="/assets/files/lazysizes.min.js"></script> -->
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/> -->
<!-- <script src="https://kit.fontawesome.com/676698b110.js" crossorigin="anonymous"></script> -->
<script defer src="https://kit.fontawesome.com/4eee35f757.js"></script>
<style>
	.blur-up {
		-webkit-filter: blur(5px);
		filter: blur(5px);
		transition: filter 400ms, -webkit-filter 400ms;
	}

	.blur-up.lazyloaded {
		-webkit-filter: blur(0);
		filter: blur(0);
	}
</style>
<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          stouty.xyz
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/">about</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/">posts</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">tags</a>
            </li><li class="masthead__menu-item">
              <a href="/things-i-use/">things</a>
            </li><li class="masthead__menu-item">
              <a href="/links/">links</a>
            </li><li class="masthead__menu-item">
              <a href="/snippets/">snippets</a>
            </li><li class="masthead__menu-item">
              <a href="/sitemap.xml">sitemap</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">James Stout</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>iOS/Web developer. Tech, crypto, comedy, Hong Kong, hcafc, smashing telly and, of course, the weather</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Hong Kong</span>
        </li>
      

      

      

      

      
        <li>
          <a href="https://keybase.io/stouty" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fas fa-fw fa-key" aria-hidden="true"></i> Keybase
          </a>
        </li>
      

      
        <li>
          <a href="https://twitter.com/stoutyhk" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter
          </a>
        </li>
      

      

      
      
      

      

      

      

      
        <li>
          <a href="https://bitbucket.org/stouty" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-bitbucket" aria-hidden="true"></i> Bitbucket
          </a>
        </li>
      

      
        <li>
          <a href="https://github.com/jamesstout" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      
        <li>
          <a href="https://last.fm/user/stoutyhk" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-lastfm-square" aria-hidden="true"></i> Last.fm
          </a>
        </li>
      

      

      

      

      

      

      

      
      <li>
        <a href="http://www.feedio.co/@stoutyhk?came_from=homepagefeedbutton" itemprop="sameAs">
          <i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feedio
        </a>
      </li>
    

    
    <li>
      <a rel="me" href="https://mastodon.social/@stouty" itemprop="sameAs">
        <i class="fab fa-fw fa-mastodon" aria-hidden="true"></i> Mastodon
      </a>
    </li>
       

      

      

      

      

      
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Nextcloud Sync Client for Docker">
    <meta itemprop="description" content="Syncing to Nextcloud from a Docker container, and how to build that container.">
    <meta itemprop="datePublished" content="2020-05-08T22:27:27+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Nextcloud Sync Client for Docker
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>I’ve found the ‘native’ macOS Nextcloud client to be a bit flakey. It’s all <a href="https://www.qt.io/">Qt</a> and <a href="https://github.com/nextcloud/desktop/search?l=c%2B%2B">C++</a> and times out all the time.</p>

<p>I’m trying to replace Dropbox on my Mac, as they get up to all sorts of <a href="https://applehelpwriter.com/2016/07/28/revealing-dropboxs-dirty-little-security-hack/">scummy</a> <a href="https://applehelpwriter.com/2016/08/29/discovering-how-dropbox-hacks-your-mac/">behaviour</a>, but it’s a little harder than expected.</p>

<p>I mentioned in an earlier post that I <a href="https://stouty.xyz/unix/2020/04/16/dupes/">sync my photos to my NAS</a>, then sync to Nextcloud via their <a href="https://docs.nextcloud.com/desktop/2.6/advancedusage.html#nextcloud-command-line-client">command line client</a>, running in a <a href="https://www.docker.com/">Docker</a> <a href="https://www.docker.com/resources/what-container">container</a>. I run all my containers on my Synology NAS using their <a href="https://www.synology.com/en-global/dsm/feature/docker">Docker package</a>:</p>

<figure class="third ">
  
    
      <a href="/assets/images/posts/nextcloud-sync/containers.png" title="Docker containers">
          <img src="/assets/images/posts/nextcloud-sync/containers-th.png" alt="Docker containers" />
      </a>
    
  
    
      <a href="/assets/images/posts/nextcloud-sync/containers2.png" title="Docker containers">
          <img src="/assets/images/posts/nextcloud-sync/containers2-th.png" alt="Docker containers" />
      </a>
    
  
    
      <a href="/assets/images/posts/nextcloud-sync/images.png" title="Docker images">
          <img src="/assets/images/posts/nextcloud-sync/images-th.png" alt="Docker images" />
      </a>
    
  
  
</figure>

<p>In the last screenshot there you can see my image: <a href="https://registry.hub.docker.com/r/stoutyhk/nextcloud-client/">stoutyhk/nextcloud-client</a>. It’s based on the image from <a href="https://github.com/juanitomint/nextcloud-client-docker">juanitomint</a>, with some <a href="https://github.com/jamesstout/nextcloud-client-docker/commit/c6184018dcc46289cbbb59060c63870814710e59">small tweaks</a> to add functionality to exclude certain folders and to set folders for selective sync. I also slightly tweaked how the arguments to the client are constructed and exposed the <code class="language-plaintext highlighter-rouge">media</code> and <code class="language-plaintext highlighter-rouge">config</code> folders.</p>

<figure class="half ">
  
    
      <a href="/assets/images/posts/nextcloud-sync/Dockerfile.png" title="Dockerfile">
          <img src="/assets/images/posts/nextcloud-sync/Dockerfile-th.png" alt="Dockerfile" />
      </a>
    
  
    
      <a href="/assets/images/posts/nextcloud-sync/run.png" title="run.sh">
          <img src="/assets/images/posts/nextcloud-sync/run-th.png" alt="run.sh" />
      </a>
    
  
  
</figure>

<p>The config folder can contain files named:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">exclude</code> - this contains files/folders/patterns that you don’t want to sync</li>
  <li><code class="language-plaintext highlighter-rouge">unsyncedfolders</code> - contains the list of un-synced remote folders (selective sync)</li>
</ul>

<p>For example, I want to exclude syncing the Synology-generated metadata <a href="https://www.reddit.com/r/synology/comments/an4a4l/modern_solution_to_stopping_the_generation_of/">@eaDir</a> directories to my server:</p>

<p>So I have a config directory containing an <code class="language-plaintext highlighter-rouge">exclude</code> file:</p>

<p><a href="/assets/images/posts/nextcloud-sync/config.png"><img data-src="/assets/images/posts/nextcloud-sync/config.png" class="lazyload align-center blur-up" alt="config folder screenshot" /></a></p>

<p>Containing:</p>

<p><a href="/assets/images/posts/nextcloud-sync/exclude.png"><img data-src="/assets/images/posts/nextcloud-sync/exclude.png" class="lazyload align-center blur-up" alt="exclude file screenshot" /></a></p>

<p>Additionally, on my server there are folders that I do not want to sync down to my NAS. So those folders go in the <code class="language-plaintext highlighter-rouge">unsyncedfolders</code> file:</p>

<p><a href="/assets/images/posts/nextcloud-sync/unsyncedfolders.png"><img data-src="/assets/images/posts/nextcloud-sync/unsyncedfolders.png" class="lazyload align-center blur-up" alt="unsyncedfolders file screenshot" /></a></p>

<p>So you download the image, launch and set the <a href="https://docs.docker.com/storage/volumes/">volumes</a> and environment variables, and start it up:</p>

<p><a href="/assets/images/posts/nextcloud-sync/nc-docker-settings.png"><img data-src="/assets/images/posts/nextcloud-sync/nc-docker-settings.png" class="lazyload align-center blur-up" alt="nc-docker-settings screenshot" /></a></p>

<p>From the command line this would be something like:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">-v</span> some_named_volume:/media/nextcloud <span class="se">\</span>
  <span class="nt">-v</span> some_config_volume:/config <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">NC_USER</span><span class="o">=</span><span class="nv">$username</span> <span class="nt">-e</span> <span class="nv">NC_PASS</span><span class="o">=</span><span class="nv">$password</span> <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">NC_URL</span><span class="o">=</span><span class="nv">$server_url</span><span class="se">\</span>
  stoutyhk/nextcloud-client
</code></pre></div></div>

<p>The Dockerfile CMD is run.sh, a script that parses the arguments to construct the nextcloudcmd command. For my setup it’s this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"/bin/su -s /bin/ash </span><span class="nv">$USER</span><span class="s2"> -c 'nextcloudcmd --exclude /config/exclude </span><span class="se">\</span><span class="s2">
--unsyncedfolders /config/unsyncedfolders --max-sync-retries 6 </span><span class="se">\</span><span class="s2">
--non-interactive -u </span><span class="nv">$NC_USER</span><span class="s2"> -p </span><span class="nv">$NC_PASS</span><span class="s2"> /media/nextcloud </span><span class="nv">$NC_URL</span><span class="s2">'"</span>
</code></pre></div></div>
<p>This simply runs in a <a href="https://tldp.org/LDP/Bash-Beginners-Guide/html/sect_09_02.html">while true loop</a>, sleeping for 500s after it syncs and then checking if it needs to sync again after 500s.</p>

<p>It’s very stable, hasn’t crashed or timed out yet. I highly recommend this method vs the native macOS client.</p>

<p>Going full No Dropbox would mean syncing further folders and mounting them on my Mac. That’s up next.</p>

<p>BTW, building and tweaking this is very simple. The <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> describes what to do:</p>

<p>Build image based on <a href="https://www.alpinelinux.org/">Alpine</a> (a tiny, 2.7MB, version of Linux):</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM alpine:latest
</code></pre></div></div>

<p>Set some ARGS and ENVS:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ARG USER=ncsync
ARG GROUP=users
ARG USER_UID=1000
ARG USER_GID=100

ENV USER=$USER \
    GROUP=$GROUP \
    USER_UID=$USER_UID \
    USER_GID=$USER_GID \
    NC_USER=username \
    NC_PASS=password \
    NC_INTERVAL=500 \
    NC_URL="" \
    NC_TRUST_CERT=false \
    NC_SILENT=false \
    NC_EXIT=false   \
    NC_HIDDEN=false \
    NC_MAX_SYNC_RETRIES=3
</code></pre></div></div>

<p>Create user/group:</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RUN adduser -G $GROUP -D -u $USER_UID $USER
</code></pre></div></div>

<p>Update repositories and install nextcloud-client:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RUN apk update &amp;&amp; apk add nextcloud-client &amp;&amp; rm -rf /etc/apk/cache
</code></pre></div></div>

<p>Add run script and expose volumes:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ADD run.sh /usr/bin/run.sh
VOLUME [ "/media/nextcloud" ]
VOLUME [ "/config" ]
</code></pre></div></div>

<p>Finally, execute the command:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CMD /usr/bin/run.sh
</code></pre></div></div>

<p>The build command to build the image is:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="se">\</span>
        <span class="nt">--build-arg</span> <span class="nv">VCS_REF</span><span class="o">=</span><span class="si">$(</span>git rev-parse <span class="nt">--short</span> HEAD<span class="si">)</span> <span class="se">\</span>
        <span class="nt">--build-arg</span> <span class="nv">BUILD_DATE</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> <span class="nt">-u</span> +<span class="s2">"%Y-%m-%dT%H:%M:%SZ"</span><span class="si">)</span> <span class="se">\</span>
        <span class="nt">-t</span> stoutyhk/nextcloud-client <span class="nb">.</span> | <span class="nb">tee </span>build.log
docker images stoutyhk/nextcloud-client
</code></pre></div></div>

<p>You can see my current image is the one from DockerHub:</p>

<p><a href="/assets/images/posts/nextcloud-sync/docker-ps.png"><img data-src="/assets/images/posts/nextcloud-sync/docker-ps.png" class="lazyload align-center blur-up" alt="docker-ps screenshot" /></a></p>

<p>The build output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@dusky2: /volume1/homes/james/src/nextcloud-client-docker on master[!?]
<span class="nv">$ </span>./build.sh
Sending build context to Docker daemon  28.67kB
Step 1/19 : FROM alpine:latest
 <span class="nt">---</span><span class="o">&gt;</span> a187dde48cd2
Step 2/19 : LABEL <span class="nv">maintainer</span><span class="o">=</span><span class="s2">"stoutyhk"</span> <span class="nv">version</span><span class="o">=</span><span class="s2">"0.1"</span> <span class="nv">description</span><span class="o">=</span><span class="s2">"nextcloud sync client"</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>d7bcd965c0d4
Removing intermediate container d7bcd965c0d4
 <span class="nt">---</span><span class="o">&gt;</span> b6a1c94582c9
Step 3/19 : LABEL based-on<span class="o">=</span><span class="s2">"https://github.com/juanitomint/nextcloud-client-docker"</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>fba05915652c
Removing intermediate container fba05915652c
 <span class="nt">---</span><span class="o">&gt;</span> 92e4f3b6aba1
Step 4/19 : LABEL <span class="nv">repo</span><span class="o">=</span><span class="s2">"https://github.com/jamesstout/nextcloud-client-docker"</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>63258ff88545
Removing intermediate container 63258ff88545
 <span class="nt">---</span><span class="o">&gt;</span> 07233dc234c6
Step 5/19 : ARG VCS_REF
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>f03e352100f4
Removing intermediate container f03e352100f4
 <span class="nt">---</span><span class="o">&gt;</span> 172784412e92
Step 6/19 : ARG BUILD_DATE
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>80600d7575e4
Removing intermediate container 80600d7575e4
 <span class="nt">---</span><span class="o">&gt;</span> 77bc2f5d481a
Step 7/19 : LABEL vcs-ref<span class="o">=</span><span class="nv">$VCS_REF</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>c58cdd8b58f6
Removing intermediate container c58cdd8b58f6
 <span class="nt">---</span><span class="o">&gt;</span> 2e598c72729a
Step 8/19 : LABEL build-date<span class="o">=</span><span class="nv">$BUILD_DATE</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>d51c564b1354
Removing intermediate container d51c564b1354
 <span class="nt">---</span><span class="o">&gt;</span> 2cf77c7ccd0f
Step 9/19 : ARG <span class="nv">USER</span><span class="o">=</span>ncsync
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>10c452b72d23
Removing intermediate container 10c452b72d23
 <span class="nt">---</span><span class="o">&gt;</span> 62d6402dfe64
Step 10/19 : ARG <span class="nv">GROUP</span><span class="o">=</span><span class="nb">users</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>2c7c84cca017
Removing intermediate container 2c7c84cca017
 <span class="nt">---</span><span class="o">&gt;</span> 32af7f7e31a6
Step 11/19 : ARG <span class="nv">USER_UID</span><span class="o">=</span>1000
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>a76b14779d6e
Removing intermediate container a76b14779d6e
 <span class="nt">---</span><span class="o">&gt;</span> d16b1dc7fda7
Step 12/19 : ARG <span class="nv">USER_GID</span><span class="o">=</span>100
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>16a3579c0537
Removing intermediate container 16a3579c0537
 <span class="nt">---</span><span class="o">&gt;</span> b06b174ac1cb
Step 13/19 : ENV <span class="nv">USER</span><span class="o">=</span><span class="nv">$USER</span>     <span class="nv">GROUP</span><span class="o">=</span><span class="nv">$GROUP</span>     <span class="nv">USER_UID</span><span class="o">=</span><span class="nv">$USER_UID</span>     <span class="nv">USER_GID</span><span class="o">=</span><span class="nv">$USER_GID</span>     <span class="nv">NC_USER</span><span class="o">=</span>username     <span class="nv">NC_PASS</span><span class="o">=</span>password     <span class="nv">NC_INTERVAL</span><span class="o">=</span>500     <span class="nv">NC_URL</span><span class="o">=</span><span class="s2">""</span>     <span class="nv">NC_TRUST_CERT</span><span class="o">=</span><span class="nb">false     </span><span class="nv">NC_SILENT</span><span class="o">=</span><span class="nb">false     </span><span class="nv">NC_EXIT</span><span class="o">=</span><span class="nb">false       </span><span class="nv">NC_HIDDEN</span><span class="o">=</span><span class="nb">false     </span><span class="nv">NC_MAX_SYNC_RETRIES</span><span class="o">=</span>3
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>85c579929ce1
Removing intermediate container 85c579929ce1
 <span class="nt">---</span><span class="o">&gt;</span> 82c168659c42
Step 14/19 : RUN adduser <span class="nt">-G</span> <span class="nv">$GROUP</span> <span class="nt">-D</span> <span class="nt">-u</span> <span class="nv">$USER_UID</span> <span class="nv">$USER</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>84755af084c9
Removing intermediate container 84755af084c9
 <span class="nt">---</span><span class="o">&gt;</span> 9888ccca2dcc
Step 15/19 : RUN apk update <span class="o">&amp;&amp;</span> apk add nextcloud-client <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /etc/apk/cache
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>702eef96b765
fetch http://dl-cdn.alpinelinux.org/alpine/v3.11/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.11/community/x86_64/APKINDEX.tar.gz
v3.11.6-32-g9ddc349524 <span class="o">[</span>http://dl-cdn.alpinelinux.org/alpine/v3.11/main]
v3.11.6-28-g4b76c8208f <span class="o">[</span>http://dl-cdn.alpinelinux.org/alpine/v3.11/community]
OK: 11273 distinct packages available
<span class="o">(</span>1/95<span class="o">)</span> Installing dbus-libs <span class="o">(</span>1.12.16-r2<span class="o">)</span>
<span class="o">(</span>2/95<span class="o">)</span> Installing libgcc <span class="o">(</span>9.2.0-r4<span class="o">)</span>
<span class="o">(</span>3/95<span class="o">)</span> Installing libffi <span class="o">(</span>3.2.1-r6<span class="o">)</span>
<span class="nt">-----8</span>&lt;<span class="nt">---snip---8</span>&lt;<span class="nt">----</span>
<span class="o">(</span>95/95<span class="o">)</span> Installing nextcloud-client <span class="o">(</span>2.6.1-r0<span class="o">)</span>
^@Executing busybox-1.31.1-r9.trigger
OK: 300 MiB <span class="k">in </span>109 packages
Removing intermediate container 702eef96b765
 <span class="nt">---</span><span class="o">&gt;</span> 3147165b6612
Step 16/19 : ADD run.sh /usr/bin/run.sh
 <span class="nt">---</span><span class="o">&gt;</span> 11a9c630e797
Step 17/19 : VOLUME <span class="o">[</span> <span class="s2">"/media/nextcloud"</span> <span class="o">]</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>69454b15f6b6
Removing intermediate container 69454b15f6b6
 <span class="nt">---</span><span class="o">&gt;</span> af98dc485510
Step 18/19 : VOLUME <span class="o">[</span> <span class="s2">"/config"</span> <span class="o">]</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>94ac262e01a9
Removing intermediate container 94ac262e01a9
 <span class="nt">---</span><span class="o">&gt;</span> b964f6b7c97c
Step 19/19 : CMD /usr/bin/run.sh
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>942c9ddf5ddd
Removing intermediate container 942c9ddf5ddd
 <span class="nt">---</span><span class="o">&gt;</span> aa064981bb5b
Successfully built aa064981bb5b
Successfully tagged stoutyhk/nextcloud-client:latest

real	5m50.592s
user	0m0.096s
sys	0m0.047s
REPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE
stoutyhk/nextcloud-client   latest              aa064981bb5b        1 second ago        311MB
stoutyhk/nextcloud-client   &lt;none&gt;              6ca8291dece4        3 weeks ago         311MB
</code></pre></div></div>

<p>You can see the <code class="language-plaintext highlighter-rouge">latest</code> tag is now pointing to image <code class="language-plaintext highlighter-rouge">aa064981bb5b</code>. To update, you export the settings, stop the container, <code class="language-plaintext highlighter-rouge">docker rm stoutyhk-nextcloud-client</code>, then import the settings and launch the new image:</p>

<p><a href="/assets/images/posts/nextcloud-sync/new-image.png"><img data-src="/assets/images/posts/nextcloud-sync/new-image.png" class="lazyload align-center blur-up" alt="new-image screenshot" /></a></p>

<p>Spot of housekeeping:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@dusky2: /usr/local/bin
<span class="nv">$ </span><span class="k">for </span>image <span class="k">in</span> <span class="si">$(</span>docker images <span class="nt">-f</span> <span class="s2">"dangling=true"</span> | <span class="nb">grep </span>stouty | <span class="nb">grep</span> <span class="nt">-vE</span> <span class="s1">'IMAGE'</span> | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span><span class="p">;</span> <span class="k">do
    </span>docker rmi <span class="s2">"</span><span class="nv">$image</span><span class="s2">"</span><span class="p">;</span>
<span class="k">done
</span>Untagged: stoutyhk/nextcloud-client@sha256:024ba23cc5e182aedb3d30df1bc4e31127fe21f94b35aed55804989b8e154a98
Deleted: sha256:6ca8291dece42c3dda0cf2b6601e0ff1180cf854909b5f3474710ca84babaf04
Deleted: sha256:be8054c4d017455ca6b4afd7e00fb7da03e58beae4a3705575aabcff8af23fb9
Deleted: sha256:c9eae4086cf6c94c60590bb909fbffa90f166371d9c13a53a4a988d48747cdcc
Deleted: sha256:688a57e452c154219a34c88e18ec695ef3a15ce4a1d4f73875d56ff40a8a6de6
</code></pre></div></div>

<p>I have a script that runs weekly to automate pulling of new images:</p>

<script src="https://gist.github.com/jamesstout/c19c227d1ac7dd37108ecbbf5c52eea7.js"></script>

<p>I then need to do the export, rm, import manually as I haven’t figured out how to automate that with Synology Docker package yet.</p>

<p><a href="https://github.com/wagoodman/dive">Dive</a> is a nice tool for examining Docker <a href="https://docs.docker.com/storage/storagedriver/#images-and-layers">images and layers</a>.</p>

<p>You can see what each command in the Dockerfile does to the image. It also gives you an image efficiency estimate:</p>

<blockquote>
  <p>Image Efficiency</p>

  <p>The lower left pane shows basic layer info and an experimental metric that will guess how much wasted space your image contains. This might be from duplicating files across layers, moving files across layers, or not fully removing files. Both a percentage “score” and total wasted file space is provided.</p>
</blockquote>

<p>Mine is fairly good:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Total Image size: 311MB
Potential wasted space: 179kB
Image efficiency score: 99 %
</code></pre></div></div>
<p>Here’s a look at <code class="language-plaintext highlighter-rouge">dive</code>:</p>

<p><a href="https://asciinema.org/a/2xQFxw4LdqjYuh9cc7WEv4Xc7"><img src="https://asciinema.org/a/2xQFxw4LdqjYuh9cc7WEv4Xc7.svg" alt="asciicast" /></a></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#dive" class="page__taxonomy-item" rel="tag">dive</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#docker-build" class="page__taxonomy-item" rel="tag">docker build</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#docker-images" class="page__taxonomy-item" rel="tag">docker images</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#docker-layers" class="page__taxonomy-item" rel="tag">docker layers</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#dockerfile" class="page__taxonomy-item" rel="tag">Dockerfile</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#docker" class="page__taxonomy-item" rel="tag">Docker</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#nas" class="page__taxonomy-item" rel="tag">NAS</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#nextcloud" class="page__taxonomy-item" rel="tag">Nextcloud</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#sync" class="page__taxonomy-item" rel="tag">sync</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#synology" class="page__taxonomy-item" rel="tag">Synology</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#nextcloud" class="page__taxonomy-item" rel="tag">nextcloud</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-05-08T22:27:27+08:00">May 8, 2020</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/ios/2020/05/04/hkwarnings/" class="pagination--pager" title="HKWarnings v5.0.0
">Previous</a>
    
    
      <a href="/ios/2020/05/09/compress-upload-cocoalumberjack/" class="pagination--pager" title="Compress-Upload-CocoaLumberjack - My First CocoaPod
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ios/2020/05/18/countly/" rel="permalink">Countly For iOS and Web Analytics
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Installing Countly server and SDK for iOS and Web analytics
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/nextcloud/2020/05/17/nextcloud-conflicting-files/" rel="permalink">Fixing Nextcloud Conflicting Files
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A bash script to correct conflicting files.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ios/2020/05/15/firebase-crashlytics/" rel="permalink">Firebase Crashlytics - Are They Having a Laugh?
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Investigating the new Firebase Crashlytics SDK.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/webdev/2020/05/11/copy-site-jekyll-hook/" rel="permalink">A Jekyll Hook to Copy Pre-Built Site to Another Directory
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">My first attempt at a Jekyll plugin, it copies the _site folder somewhere else.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><div class="search-searchbar"></div>
  <div class="search-hits"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 stouty.xyz. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script defer src="/assets/files/lazysizes.min.js"></script>
  <script defer src="/assets/js/main.min.js"></script>
  <!-- <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script> -->
  <!-- <script defer src="https://kit.fontawesome.com/4eee35f757.js"></script> -->



<!-- Including InstantSearch.js library and styling -->

<script>
  head.load("https://cdn.jsdelivr.net/npm/instantsearch.js@2.9.0/dist/instantsearch.min.js", function() {
    // Instanciating InstantSearch.js with Algolia credentials
    const search = instantsearch({
      appId: 'TE1537XNZ4',
      apiKey: 'c3967c693f4a1d3ca8ed221f259c6a5f',
      indexName: 'stouty.xyz',
      searchParameters: {
        restrictSearchableAttributes: [
        'title',
        'content'
        ]
      }
    });
    
    const hitTemplate = function(hit) {
      const url = hit.url;
      const title = (hit._highlightResult.title !== undefined) ? hit._highlightResult.title.value : "";
      const content = (hit._highlightResult.html !== undefined) ? hit._highlightResult.html.value : undefined;
      
      if(content === undefined){
        throw "whoops";
      }
      else{
        return `
        <div class="list__item">
          <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
            <h2 class="archive__item-title" itemprop="headline"><a href="${url}">${title}</a></h2>
            <div class="archive__item-excerpt" itemprop="description">${content}</div>
          </article>
        </div>
        `;
      }
    }
    
    // Adding searchbar and results widgets
    search.addWidget(
    instantsearch.widgets.searchBox({
      container: '.search-searchbar',
      poweredBy: true,
      placeholder: 'Enter your search term...'
    })
    );
    search.addWidget(
    instantsearch.widgets.hits({
      container: '.search-hits',
      templates: {
        item: hitTemplate
      }
    })
    );
    
    // Starting the search
    search.start();
  });
</script>

<!-- <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.8.0/dist/instantsearch.min.js"></script> -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.9.0/dist/instantsearch.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.9.0/dist/instantsearch-theme-algolia.min.css">







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-121620384-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-121620384-1', { 'anonymize_ip': false});
</script>





<style>
    .videoWrapper {
        position: relative;
        padding-bottom: 56.333%;
        height: 0;
        background: black;
    }
    .videoWrapper iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
    }    
    </style>
    
    <script>
    function get_youtube_id(url) {
        var p = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
        return (url.match(p)) ? RegExp.$1 : false;
    }
    function vimeo_embed(url,el) {
        var id = false;
        $.ajax({
          url: 'https://vimeo.com/api/oembed.json?url='+url,
          async: true,
          success: function(response) {
            if(response.video_id) {
              id = response.video_id;
              if(url.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
              if(url.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
              var theInnerHTML = '<div class="videoWrapper"><iframe src="https://player.vimeo.com/video/'+id+'/?byline=0&title=0&portrait=0';
              if(autoplay==1) theInnerHTML += '&autoplay=1';
              if(loop==1) theInnerHTML += '&loop=1';
              theInnerHTML += '" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>'; 
              el.innerHTML = theInnerHTML;
            }
          }
        });
    }
    function video_embed() {
        var p = document.getElementsByTagName('p');
        for(var i = 0; i < p.length; i++) {
            //check if this is an external url (that starts with https:// or http://
            if (p[i].innerHTML.indexOf("http://") == 0 ||
                p[i].innerHTML.indexOf("https://") == 0) {
                var youtube_id = get_youtube_id(p[i].innerHTML);
                if(youtube_id) {
                    if(p[i].innerHTML.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                    if(p[i].innerHTML.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                    var theInnerHTML = '<div class="videoWrapper"><iframe width="720" height="420" src="https://www.youtube.com/embed/' + youtube_id + '?rel=0&showinfo=0';
                    if(autoplay==1) theInnerHTML += '&autoplay=1';
                    if(loop==1) theInnerHTML += '&loop=1&playlist='+youtube_id+'&version=3';
                    if(p[i].innerHTML.indexOf('start=') !== -1) theInnerHTML += '&start='+p[i].innerHTML.substring(p[i].innerHTML.indexOf('start=')+6);
                    theInnerHTML += '" frameborder="0" allowfullscreen></iframe></div>';
                    p[i].innerHTML = theInnerHTML;
                }
                if(p[i].innerHTML.indexOf('vimeo.com') !== -1) {
                    //ask vimeo for the id and place the embed
                    vimeo_embed(p[i].innerHTML,p[i]);
                }
            }
        }
    }
    video_embed();
    
    function mp3_embed() {
        var p = document.getElementsByTagName('p');
        for(var i = 0; i < p.length; i++) {
            if(p[i].innerHTML.indexOf('.mp3') !== -1) {
                var str = p[i].innerHTML.split('?');
                if(str.length == 1) str[1] = '';
                var str1 = str[1];
                str1 = str1.replace('&','').replace('&','');
                str1 = str1.replace('autoplay=1','').replace('autoplay=0','');
                str1 = str1.replace('loop=1','').replace('loop=0','');
                str1 = str1.replace('controls=0','').replace('controls=1','');
    
                if (str[0].lastIndexOf('.mp3', str[0].length - 4) === str[0].length - 4 && str1.length == 0) {
                    if(str[1].indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                    if(str[1].indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                    if(str[1].indexOf('controls=0') !== -1) var controls=0; else var controls=1;
                    var newInnerHTML = '<audio';
                    if(autoplay==1) newInnerHTML += ' autoplay';
                    if(loop==1) newInnerHTML += ' loop';
                    if(controls==1) newInnerHTML += ' controls';
                    newInnerHTML += '><source src="'+str[0]+'" type="audio/mpeg">Your browser does not support the audio element.</audio>';
                    p[i].innerHTML = newInnerHTML;
                }
            }
        }
    }
    mp3_embed();
    </script>




  </body>
</html>
